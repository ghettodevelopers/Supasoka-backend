generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  deviceId          String             @unique
  email             String?            @unique
  phoneNumber       String?
  isSubscribed      Boolean            @default(false)
  subscriptionType  String?
  subscriptionStart DateTime?
  subscriptionEnd   DateTime?
  trialUsed         Boolean            @default(false)
  totalWatchTime    Int                @default(0)
  lastActive        DateTime           @default(now())
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deviceToken       String?
  activatedAt       DateTime?
  activatedBy       String?
  isActivated       Boolean            @default(false)
  isBlocked         Boolean            @default(false)
  blockedAt         DateTime?
  blockedBy         String?
  blockReason       String?
  points            Int                @default(0)
  remainingTime     Int                @default(0)
  uniqueUserId      String?            @unique
  accessLevel       String             @default("basic")
  accessExpiresAt   DateTime?
  adViews           AdView[]
  downloads         Download[]
  pointsHistory     PointsHistory[]
  notifications     UserNotification[]
  watchHistory      WatchHistory[]
  paymentRequests   PaymentRequest[]
  channelAccess     ChannelAccess[]

  @@index([deviceId], map: "idx_users_device_id")
  @@index([lastActive], map: "idx_users_last_active")
  @@index([uniqueUserId], map: "idx_users_unique_user_id")
  @@map("users")
}

model Channel {
  id             String          @id @default(cuid())
  name           String
  logo           String?
  category       String
  color          String
  hd             Boolean         @default(true)
  streamUrl      String
  backupUrls     String?
  drmConfig      String?
  isActive       Boolean         @default(true)
  priority       Int             @default(0)
  description    String?
  isFeatured     Boolean         @default(false)
  featuredOrder  Int             @default(0)
  featuredImage  String?         // Special image for featured section
  featuredTitle  String?         // Custom title for featured section
  featuredDesc   String?         // Custom description for featured section
  isFree         Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  downloads      Download[]
  watchHistory   WatchHistory[]

  @@index([isActive], map: "idx_channels_is_active")
  @@index([isFeatured], map: "idx_channels_is_featured")
  @@index([isFree], map: "idx_channels_is_free")
  @@map("channels")
}

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  icon      String
  priority  Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

model WatchHistory {
  id          String   @id @default(cuid())
  userId      String
  channelId   String
  watchTime   Int
  sessionTime Int
  quality     String?
  createdAt   DateTime @default(now())
  channel     Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_watch_history_user_id")
  @@map("watch_history")
}

model Download {
  id          String    @id @default(cuid())
  userId      String
  channelId   String
  fileName    String
  fileSize    Int
  downloadUrl String
  status      String    @default("pending")
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  channel     Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("downloads")
}

model Notification {
  id                String             @id @default(cuid())
  title             String
  message           String
  type              String             @default("general")
  targetUsers       String?
  isActive          Boolean            @default(true)
  scheduledAt       DateTime?
  sentAt            DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  userNotifications UserNotification[]

  @@index([isActive], map: "idx_notifications_is_active")
  @@map("notifications")
}

model UserNotification {
  id             String       @id @default(cuid())
  userId         String
  notificationId String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  clicked        Boolean      @default(false)
  clickedAt      DateTime?
  deliveredAt    DateTime?
  createdAt      DateTime     @default(now())
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationId])
  @@map("user_notifications")
}

model Admin {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String
  role      String    @default("admin")
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("admins")
}

model AppSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("app_settings")
}

model Analytics {
  id              String   @id @default(cuid())
  date            DateTime @unique @default(now())
  totalUsers      Int      @default(0)
  activeUsers     Int      @default(0)
  newUsers        Int      @default(0)
  totalWatchTime  Int      @default(0)
  totalDownloads  Int      @default(0)
  popularChannels String?
  createdAt       DateTime @default(now())

  @@map("analytics")
}

model TranscodingJob {
  id              String    @id @default(cuid())
  channelId       String
  sourceUrl       String
  targetQualities String
  status          String    @default("pending")
  progress        Int       @default(0)
  outputUrls      String?
  errorMessage    String?
  userId          String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?

  @@map("transcoding_jobs")
}

model QualityChangeLog {
  id          String   @id @default(cuid())
  userId      String
  channelId   String
  fromQuality String
  toQuality   String
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now())

  @@map("quality_change_logs")
}

model CarouselImage {
  id          String    @id @default(cuid())
  imageUrl    String
  title       String
  description String?
  linkUrl     String?
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("carousel_images")
}

model PointsHistory {
  id          String   @id @default(cuid())
  userId      String
  points      Int
  type        String
  description String?
  adId        String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("points_history")
}

model AdView {
  id           String   @id @default(cuid())
  userId       String
  adId         String
  adType       String
  pointsEarned Int      @default(10)
  duration     Int?
  completed    Boolean  @default(false)
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ad_views")
}

model Advertisement {
  id           String   @id @default(cuid())
  title        String
  description  String?
  adType       String
  videoUrl     String?
  imageUrl     String?
  duration     Int?
  pointsReward Int      @default(10)
  isActive     Boolean  @default(true)
  priority     Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("advertisements")
}

model ContactSettings {
  id             String   @id @default(cuid())
  whatsappNumber String?
  callNumber     String?
  supportEmail   String?
  isActive       Boolean  @default(true)
  updatedBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("contact_settings")
}

model PaymentRequest {
  id               String    @id @default(cuid())
  transactionId    String    @unique
  userId           String
  networkId        String
  networkName      String
  phoneNumber      String
  amount           Float
  subscriptionPlan String
  status           String    @default("pending")
  reference        String?
  createdAt        DateTime  @default(now())
  completedAt      DateTime?
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([transactionId], map: "idx_payment_requests_transaction_id")
  @@index([userId], map: "idx_payment_requests_user_id")
  @@index([status], map: "idx_payment_requests_status")
  @@map("payment_requests")
}

model AdminAuditLog {
  id          String   @id @default(cuid())
  adminId     String
  adminEmail  String
  action      String   // 'channel_create', 'channel_update', 'channel_delete', 'user_block', 'user_unblock', 'carousel_update', etc.
  entityType  String   // 'channel', 'user', 'carousel', 'notification', 'settings'
  entityId    String?
  details     String?    // Additional action details
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([adminId], map: "idx_admin_audit_logs_admin_id")
  @@index([action], map: "idx_admin_audit_logs_action")
  @@index([entityType], map: "idx_admin_audit_logs_entity_type")
  @@index([createdAt], map: "idx_admin_audit_logs_created_at")
  @@map("admin_audit_logs")
}

model ChannelAccess {
  id              String    @id @default(cuid())
  userId          String
  channelId       String
  accessType      String    // 'money', 'points', 'free', 'subscription'
  pointsSpent     Int       @default(0)
  amountPaid      Float     @default(0)
  transactionId   String?
  sessionId       String?   // Unique session ID for points-based access
  expiresAt       DateTime? // For points-based single-session access
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId, sessionId])
  @@index([userId], map: "idx_channel_access_user_id")
  @@index([channelId], map: "idx_channel_access_channel_id")
  @@index([sessionId], map: "idx_channel_access_session_id")
  @@index([expiresAt], map: "idx_channel_access_expires_at")
  @@map("channel_access")
}
